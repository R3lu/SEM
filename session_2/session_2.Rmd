---
title: "SEM 1"
author: "Simon Roth"
date: "21.4.2017"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
  html_document:
    theme: spacelab
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{rotating}
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F # Whether to display code along with its results
                      , eval = T # Whether to evaluate the code and include its results
                      , results = "hide" # this at deafult is in end much more efficient
                      , cache = F # Whether to cache results for future renders (efficient!)
                      , warning = F # Whether to display errors
                      , message = F # Whether to display messages
                      , error = F # mybe turn on
                      , tidy = F # Whether to reformat code in a tidy way when displaying it
                      #, root.dir = normalizePath('/Users/simonroth/Dropbox/methods/git/tidy_textmining/my_summary/') 
                      #, root.dir = normalizePath("E:/Dropbox/methods/git/tidy_textmining")
                      # in order to calculate relative paths
                      , fig.width = 6
                      , fig.height = 4
                      , fig.align = "center"
                      )
```

<style type="text/css">
body, td {
   font-size: 14px;
}
r.code{
  font-size: 10px;
}
pre {
  font-size: 10px
}
</style>

# Datensatz einladen

```{r load}
rm(list=ls())
load("/Users/simonroth/Dropbox/uni/MA/4_semester/SEM/data/allbus_final/allbus_Rdata.Rdata")
```

a. german: Staatsbürgerschaft
* 1 Ja, ausschließlich
* 2 Ja, neben 2. Staatsbürgerschaft
* 3 Nein

b. eastwest: Erhebungsgebiet
* 1 West 
* 2 Ost

## Itembatterien 

**Islamophobie:** 

* mm01: ISLAMAUSUEBUNG IN BRD BESCHRAENKEN
    + -10 Befragter gehört einer islamischen Religionsgemeinschaft an (Code 1 in rd03)
    + -9
    + 1 Stimme überhaupt nicht zu
    + 2
    + 3
    + 4
    + 5 
    + 6 
    + 7 Stimme voll und ganz zu
* mm02: ISLAM PASST IN DIE DEUTSCHE GESELLSCHAFT
* mm03: ANWESENHEIT VON MUSLIMEN BRINGT KONFLIKT
* mm04: STAAT SOLLTE ISLAM. GRUPPEN BEOBACHTEN
* mm05: MUSLIMISCHER BUERGERMEISTER IN ORDNUNG
* mm06: UNTER MUSLIMEN SIND VIELE REL. FANATIKER


<!-- **Einbürgerung:** -->

<!-- * mn01: EINBUERGERUNG: SOLLTE HIER GEBOREN SEIN -->
<!-- * mn02: EINBUERGERUNG: DEUTSCHE ABSTAMMUNG HABEN -->
<!-- * mn03: EINBUERGERUNG: DEUTSCH SPRECHEN -->
<!-- * mn04: EINBUERGERUNG: LANGE BEI UNS GELEBT -->
<!-- * mn05: EINBUERGERUNG: LEBENSSTILANPASSUNG -->
<!-- * mn06: EINBUERGERUNG: IN CHRISTLICH.KIRCHE SEIN -->
<!-- * mn07: EINBUERGERUNG: KEINE STRAFTATEN -->
<!-- * mn08: EINBUERGERUNG: EIGENER LEBENSUNTERHALT -->
<!-- * mn09: EINBUERGERUNG: ZU GRUNDGESETZ BEKENNEN -->
<!-- * mn10: KOENNEN MIGRANTEN ECHTE DEUTSCHE WERDEN? -->


**Nationalbewusstsein:**

* mn11: DEUTSCH SEIN: DEUTSCHE STAATSBUERGERSCH.
* mn12: DEUTSCH SEIN: CHRISTL.RELIGION ZUGEHOER.
* mn13: DEUTSCH SEIN: BEKENNTNIS ZUR DEMOKRATIE
* mn14: DEUTSCH SEIN: VIELE DEUTSCHE BEKANNTE
* mn15: DEUTSCH SEIN: ALTE STAATSANGEH.AUFGEBEN
* mn16: DEUTSCH SEIN: VERBUNDENHEIT ZU DEUTSCHL.
* mn17: DEUTSCH SEIN: ALTE GEBRAEUCHE ABLEGEN
* mn18: DEUTSCH SEIN: GUT DEUTSCH SPRECHEN
* mn19: DEUTSCH SEIN: WESTLICHE WERTE TEILEN
* mn20: DEUTSCH SEIN: MIND. 1 ELTERNTEIL DEUTSCH
* mn21: DEUTSCH SEIN: IN DEUTSCHLAND GEBOREN


# Daten partitionieren

* sex: GESCHLECHT (Int.: Geschlecht der befragten Person ohne Befragen eintragen!)
    + 1 Männlich 
    + 2 Weiblich
* age: ALTER: metrisch
* agec: ALTER: KATEGORISIERT 6
    + 18 - 29 Jahre
    + 30 - 44 Jahre
    + 45 - 59 Jahre
    + 60 - 74 Jahre
    + 75 - 89 Jahre
    + Über 89 Jahre
* isced97: BEFR.: ISCED 1997 - 6 STUFEN: International Standard Classification of Education (ISCED) 1997, 6 Stufen
    1. Level - Primary education or first stage of basic education
    2. Level - Lower secondary or second stage of basic education
    3. Level - (Upper) secondary education
    4. Level - Post-secondary non-tertiary education
    5. Level - First stage of tertiary education
    6. Level - Second stage of tertiary education
* Allgemeiner Bildungsabschluss?

## Missing Pattern

NZ (Fragebogen- Split): Befragter hat aufgrund eines methodischen oder inhaltlichen Splits eine Frage oder Item- batterie nicht gestellt bekommen.

```{r, results = "asis"}
library(dplyr)


li <- list()
for(i in seq_along(colnames(dat))){
    tab <- dat[[i]] %>%
    is.na() %>%
    table() %>%
    prop.table() * 100
    tab1 <- as.data.frame(tab)
    tab1$var <- colnames(dat)[i]
    tab1$ord <- i
    li[[i]] <- tab1
}

miss <- do.call("rbind", li)
colnames(miss) <- c("fehlt", "prop", "var", "ord")


library(ggplot2)
library(ggthemes)

miss$var <- factor(miss$var, levels = miss$var[order(miss$ord)])
miss$prop <- round(miss$prop, 2)

lab <- paste0("NA = ", miss$prop, "%")
lab[unique(miss$var)] <- ''

gg1 <- miss %>%
  ggplot(aes(x = var, y = prop, fill = fehlt)) +
  geom_bar(stat = "identity", alpha = .7) + 
  theme_classic() + 
  scale_fill_gdocs() +
  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
  geom_text(aes(y = prop + 20, label = lab), angle = 90) +
  scale_y_continuous(labels = paste0(seq(0,100,10), "%"), 
                     breaks = seq(0,100,10), limits = c(0,100))

gg1


###
library(reshape2)
library(ggplot2)

ggplot_missing <- function(x){
  
  dat %>% 
    is.na %>%
    melt %>%
    ggplot(data = .,
           aes(x = Var2,
               y = Var1)) +
    geom_raster(aes(fill = value), alpha = .7) +
    scale_fill_grey(name = "",
                    labels = c("Present","Missing")) +
    theme_minimal() + 
    theme(axis.text.x  = element_text(angle=45, vjust=0.5)) + 
    labs(x = "Variables in Dataset",
         y = "Rows / observations")
}

ggplot_missing(dat)
```

## Load VIM package for Visualization and Imputation of Missing Values

```{r, result = "asis", eval = F}
library(VIM)

## in number
aggr(dat, prop = F, numbers = T)

## in proportions
aggr(dat, prop = T, numbers = T)

## Matrix plot. Red for missing values, Darker values are high values.
# matrixplot(dat, interactive = F, sortby = NULL)

## Margin plot. Red dots have at least one missing. No observation with two missing values here.
# marginplot(sleep[,c("Gest","Dream")])
```


```{r, result = "asis", eval = F}
scattmatrixMiss(dat[,7:16], interactive = F)
scattmatrixMiss(dat[,17:22], interactive = F)
library(mice)
# md.pattern(dat)
```


```{r}
## Create data frame indicating missingness by 1
x <- as.data.frame(abs(is.na(dat)))
## Select columns with some (but not all) missing values
y <- x[,sapply(x, sd) > 0]

## Create a correlation matrix: Variables missing together have high correlation
cor_tab <- round(cor(y), 2)
cor_tab[lower.tri(cor_tab)]<- ''
# cor_tab
```

\newpage
\blandscape
```{r xtable, results="asis", eval = T}
library(xtable)
print(xtable(cor_tab, caption="Pearson's correlation matrix of missing values"),
      rotate.colnames = T, size = "small", comment = F, missing = "?")
```
\elandscape



## Little Test
*A Test of Missing Completely at Random for Multivariate Data with Missing Values*
Roderick J. A. Little (1988)

**Nullhypothesis: missing values pattern are missing completly at random**


```{r, eval = F, echo = T}
# install.packages("BaylorEdPsych")
# install.packages("mvnmle")

library(BaylorEdPsych)
little_islam <- LittleMCAR(islam)
little_islam$amount.missing
little_islam$p.value

little_nation <- LittleMCAR(nation)
little_nation$amount.missing
little_nation$p.value
```




## FEHLT Variable
```{r}
nation <- dat[,6:16]
islam <- dat[,17:22]

### Islamophobie
m <- c()
for(i in 1:nrow(nation)){
  m[i] <- ifelse(any(is.na(nation[i,]) > 0), 1, 0)
}
dat$FEHLT_nation <- m

names(dat)
log1 <- glm(FEHLT_nation ~ gender + age + isced97, data = dat)
# summary(log1)


### Nationalbewusstsein
m <- c()
for(i in 1:nrow(islam)){
  m[i] <- ifelse(any(is.na(islam[i,]) > 0), 1, 0)
}
dat$FEHLT_islam <- m

log2 <- glm(FEHLT_islam ~ gender + age + isced97, data = dat)
# summary(log2)
```

```{r, results = "asis", comment = F}
#names(dat)
library(stargazer)
stargazer(list(log1, log2),
          type = "latex",
          header = F,
          apply.coef = exp,
          apply.se = exp)
```










