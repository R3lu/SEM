---
title: "SEM 2"
author: "Simon Roth"
date: "02.05.2017"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
  html_document:
    theme: spacelab
  rmarkdown::github_document: default
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{rotating}
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F # Whether to display code along with its results
                      , eval = T # Whether to evaluate the code and include its results
                      , results = "hide" # this at deafult is in end much more efficient
                      , cache = F # Whether to cache results for future renders (efficient!)
                      , warning = F # Whether to display errors
                      , message = F # Whether to display messages
                      , error = F # mybe turn on
                      , tidy = F # Whether to reformat code in a tidy way when displaying it
                      #, root.dir = normalizePath('/Users/simonroth/Dropbox/methods/git/tidy_textmining/my_summary/') 
                      #, root.dir = normalizePath("E:/Dropbox/methods/git/tidy_textmining")
                      # in order to calculate relative paths
                      , fig.width = 6
                      , fig.height = 4
                      , fig.align = "center"
                      )
```

```{r load, echo=F}
rm(list=ls())
load("/Users/simonroth/Dropbox/uni/MA/4_semester/SEM/data/allbus_final/allbus_Rdata.Rdata")
```


## Itembatterien 

**Islamophobie:** 

* mm01: ISLAMAUSUEBUNG IN BRD BESCHRAENKEN
    + -10 Befragter gehört einer islamischen Religionsgemeinschaft an (Code 1 in rd03)
    + -9
    + 1 Stimme überhaupt nicht zu
    + 2
    + 3
    + 4
    + 5 
    + 6 
    + 7 Stimme voll und ganz zu
* mm02: ISLAM PASST IN DIE DEUTSCHE GESELLSCHAFT
* mm03: ANWESENHEIT VON MUSLIMEN BRINGT KONFLIKT
* mm04: STAAT SOLLTE ISLAM. GRUPPEN BEOBACHTEN
* mm05: MUSLIMISCHER BUERGERMEISTER IN ORDNUNG
* mm06: UNTER MUSLIMEN SIND VIELE REL. FANATIKER



**Nationalbewusstsein:**

* mn11: DEUTSCH SEIN: DEUTSCHE STAATSBUERGERSCH.
* mn12: DEUTSCH SEIN: CHRISTL.RELIGION ZUGEHOER.
* mn13: DEUTSCH SEIN: BEKENNTNIS ZUR DEMOKRATIE
* mn14: DEUTSCH SEIN: VIELE DEUTSCHE BEKANNTE
* mn15: DEUTSCH SEIN: ALTE STAATSANGEH.AUFGEBEN
* mn16: DEUTSCH SEIN: VERBUNDENHEIT ZU DEUTSCHL.
* mn17: DEUTSCH SEIN: ALTE GEBRAEUCHE ABLEGEN
* mn18: DEUTSCH SEIN: GUT DEUTSCH SPRECHEN
* mn19: DEUTSCH SEIN: WESTLICHE WERTE TEILEN
* mn20: DEUTSCH SEIN: MIND. 1 ELTERNTEIL DEUTSCH
* mn21: DEUTSCH SEIN: IN DEUTSCHLAND GEBOREN


# Daten partitionieren

* sex: GESCHLECHT (Int.: Geschlecht der befragten Person ohne Befragen eintragen!)
    + 1 Männlich 
    + 2 Weiblich
* age: ALTER: metrisch
* agec: ALTER: KATEGORISIERT 6
    + 18 - 29 Jahre
    + 30 - 44 Jahre
    + 45 - 59 Jahre
    + 60 - 74 Jahre
    + 75 - 89 Jahre
    + Über 89 Jahre
* isced97: BEFR.: ISCED 1997 - 6 STUFEN: International Standard Classification of Education (ISCED) 1997, 6 Stufen
    1. Level - Primary education or first stage of basic education
    2. Level - Lower secondary or second stage of basic education
    3. Level - (Upper) secondary education
    4. Level - Post-secondary non-tertiary education
    5. Level - First stage of tertiary education
    6. Level - Second stage of tertiary education
* Allgemeiner Bildungsabschluss?

## Listewise Deletion

```{r, results = "asis", comment = F, eval = T}
library(dplyr)
#glimpse(dat)

# listwise muslim
islam_ld <- dat %>%
  select(stop_islam:muslim_rad) %>%
  na.omit()

islam_ld <- sapply(islam_ld, plyr::each(mean, median, sd, var, min, max)) %>%
  t() %>%
  as.data.frame()

islam_ld$method <- "listwise deletion"

### listwise nation
nation_ld <- dat %>%
  select(ger_citiz:born_ger) %>%
  na.omit()

nation_ld <- sapply(nation_ld, plyr::each(mean, median, sd, var, min, max)) %>%
  t() %>%
  as.data.frame()

nation_ld$method <- "listwise deletion"

library(stargazer)
stargazer(islam_ld, 
          summary = F,
          header = F,
          digits = 2,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Deskriptive Statistik für die Item-Batterie 
          Islamophobie und Listewise Deletion fehlender Werte")

stargazer(nation_ld, 
          summary = F,
          header = F,
          digits = 2,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Deskriptive Statistik für die Item-Batterie 
          Nationalbewusstsein und Listewise Deletion fehlender Werte")
```

## Mean Imputation 1

```{r, results = "asis", comment = F, eval = T}
### Islamophobie
islam_mean1 <- dat %>% select(stop_islam:muslim_rad)
for(i in 1:length(islam_mean1)){
  islam_mean1[is.na(islam_mean1[[i]]), i] <- mean(islam_mean1[[i]], na.rm = T)
}

islam_mean1 <- sapply(islam_mean1, plyr::each(mean, median, sd, var, min, max)) %>%
  t() %>%
  as.data.frame()

islam_mean1$method <- "mean imputation"



### Nationalbewusstsein
nation_mean1 <- dat %>% select(ger_citiz:born_ger)
for(i in 1:length(nation_mean1)){
  nation_mean1[is.na(nation_mean1[[i]]), i] <- mean(nation_mean1[[i]], na.rm = T)
}

nation_mean1 <- sapply(nation_mean1, plyr::each(mean, median, sd, var, min, max)) %>%
  t() %>%
  as.data.frame()

nation_mean1$method <- "mean imputation"


stargazer(islam_mean1, 
          summary = F,
          header = F,
          digits = 2,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Deskriptive Statistik für die Item-Batterie 
          Islamophobie und Mean Imputation fehlender Werte")

stargazer(nation_mean1, 
          summary = F,
          header = F,
          digits = 2,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Deskriptive Statistik für die Item-Batterie 
          Islamophobie und Mean Imputation fehlender Werte")
```



## Mean Imputation 2 (mice)

```{r}
library(mice)

islam_mean2 <- dat %>% select(stop_islam:muslim_rad)
nation_mean2 <- dat %>% select(ger_citiz:born_ger)

### run imputation
# get default predictor matrix
# Unconditional mean imputation (numeric)

islam_mean2_imp <- mice(islam_mean2, 
          method = rep("mean", length(islam_mean2)))

stacked.data <- complete(islam_mean2_imp,
                       "long",
                       inc = F)
head(stacked.data)


####monitor convergence
plot(islam_mean2_imp,layout = c(2, 3)) 

islam_mean2_imp <- mice(islam_mean2)
plot(islam_mean2_imp,layout = c(2, 3)) 
```

## merge data
```{r, results = "asis", comment = F, eval = T}
islam_all <- rbind(islam_ld, islam_mean1)
islam_all <- cbind(vars = rownames(islam_all), islam_all) 

names(islam_all)
islam_all <- islam_all %>% arrange(vars)
islam_all$vars[grep("1", islam_all$vars)] <- ''

stargazer(islam_all, 
          summary = F,
          header = F,
          digits = 2,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Alle")

```




```{r, result = "asis", eval = F}
## Load VIM package for Visualization and Imputation of Missing Values
library(VIM)

## in number
aggr(dat, prop = F, numbers = T)

## in proportions
aggr(dat, prop = T, numbers = T)

## Matrix plot. Red for missing values, Darker values are high values.
# matrixplot(dat, interactive = F, sortby = NULL)

## Margin plot. Red dots have at least one missing. No observation with two missing values here.
# marginplot(sleep[,c("Gest","Dream")])
```


```{r, result = "asis", eval = F}
scattmatrixMiss(dat[,7:16], interactive = F)
scattmatrixMiss(dat[,17:22], interactive = F)
library(mice)
# md.pattern(dat)
```


```{r}
## Create data frame indicating missingness by 1
x <- as.data.frame(abs(is.na(dat)))
## Select columns with some (but not all) missing values
y <- x[,sapply(x, sd) > 0]

## Create a correlation matrix: Variables missing together have high correlation
cor_tab <- round(cor(y), 2)
cor_tab[lower.tri(cor_tab)]<- ''
# cor_tab
```

\blandscape
```{r xtable, results="asis", eval = F}
library(xtable)
print(xtable(cor_tab, caption="Pearson's correlation matrix of missing values"),
      rotate.colnames = T, size = "small", comment = F, missing = "?")
```
\elandscape


```{r, results = "asis", comment = F, eval = F}
### 2.2 T-Tests

## isced
fit_isced_nation <-aov(isced97 ~ FEHLT_nation, data=dat)
fit_isced_islam <- aov(isced97 ~ FEHLT_islam, data=dat)

library(tidyr)
library(broom)
library(stargazer)

anov_table1 <- broom::tidy(fit_isced_nation)
stargazer(anov_table1, 
          summary = F,
          header = F,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Varianzanalyse für ISCED (Fehlt nation)")


anov_table2 <- broom::tidy(fit_isced_islam)
stargazer(anov_table2, 
          summary = F,
          header = F,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Varianzanalyse für ISCED (Fehlt islam)")


### gender
fit_gender_nation <- t.test(FEHLT_nation ~ gender, data = dat)
fit_gender_islam <- t.test(FEHLT_islam ~ gender, data = dat)

anov_table5 <- broom::tidy(fit_gender_nation)
stargazer(t(anov_table5), 
          summary = F,
          header = F,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Zweiseitiger T-Test für Geschlecht (Fehlt nation)")

anov_table6 <- broom::tidy(fit_gender_islam)
stargazer(t(anov_table6), 
          summary = F,
          header = F,
          type = "latex",
          #type = "html",
          style = "ajps",
          title = "Zweiseitiger T-Test für Geschlecht (Fehlt islam)")

```



